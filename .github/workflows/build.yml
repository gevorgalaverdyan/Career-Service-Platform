on: push

jobs: 
  build-node:
    name: Running Tests
    runs-on: ubuntu-latest
    container: node:16
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Cache node modules
        uses: actions/cache@v2
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install packages
        run: |
          chown -R $(whoami) /usr/local/lib/node_modules
          curl -Ls https://deb.nodesource.com/setup_16.x | bash -
          apt-get install -y nodejs
          npm ci --no-optional --prefer-offline --no-audit --progress=false
          npm fund
          npm audit --audit-level=high

      - name: Run tests
        run: |
          npm run test

      - name: Send coverage report to Codacy
        if: always()
        uses: codacy/codacy-coverage-reporter-action@v1
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          coverage-reports: coverage/lcov.info
        env:
          CI: true

# on: push

# jobs: 
#   build-node:
#     name: Running Tests
#     runs-on: ubuntu-latest
#     container: node:16
#     steps:
#       - run: node --version
#       - run: npm --version
#       - uses: actions/checkout@v3
#       - run: npm i ts-node -g
#       - run: npm install --force
#       - run: npm run test

#       - uses: actions/checkout@v2
#       - name: Install Codacy coverage reporter
#         run: curl -Ls https://coverage.codacy.com/get.sh | bash
#       - name: Run codacy-coverage-reporter
#         uses: codacy/codacy-coverage-reporter-action@v1
#         with:
#           project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
#           coverage-reports: coverage/lcov.info
#         env:
#             CI: true

  # codacy-coverage-reporter:
  #   needs: build-node
  #   name: codacy-coverage-reporter
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v2
  #     - name: Run codacy-coverage-reporter
  #       uses: codacy/codacy-coverage-reporter-action@v1
  #       with:
  #         project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
  #         # or
  #         # api-token: ${{ secrets.CODACY_API_TOKEN }}
  #         coverage-reports: coverage/lcov.info
  #         # or a comma-separated list for multiple reports
  #         # coverage-reports: <PATH_TO_REPORT>, <PATH_TO_REPORT>
